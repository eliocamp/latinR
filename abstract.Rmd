---
title: "abstract"
author: "Elio Campitelli"
date: "April 4, 2018"
# documentclass: llncs
# classoption: twocolumn
output: 
   pdf_document:
      latex_engine: xelatex
      keep_tex: yes
biblio-style: apalike-es
bibliography:
  - biblio.bib
  - packages.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(self.contained = FALSE)
   
knitr::write_bib(c("base", "data.table", "ggplot2", "metR"), 
                 file = "packages.bib")

predict_data_size = function(numeric_size, number_type = "numeric") {
  if(number_type == "integer") {
    byte_per_number = 4
  } else if(number_type == "numeric") {
    byte_per_number = 8
  } else {
    stop(sprintf("Unknown number_type: %s", number_type))
  }
  estimate_size_in_bytes = (numeric_size * byte_per_number)
  class(estimate_size_in_bytes) = "object_size"
  print(estimate_size_in_bytes, units = "auto")
}
```

# Introducción

Gran parte de la investigación en ciencias de la atmósfera consiste en el análisis y visualización de datos.

Un software de visualización de datos meteorológicos y oceanográficos muy utilizado es GrADs (Grid Analysis and Display System) el cual permite leer y graficar campos escalares y vectoriales con gran facilidad. Sin emabrgo, su lenguaje de scripting es muy limitado, carece de capacidades estadísticas nativas y no existen gran cantidad de extensiones que las implementen. R, en cambio, posee implementaciones de virtualmente cualquier tratamiento estadístico usado en ciencias de la atmósfera y el paquete `raster` que permite leer y graficar datos geográficos con relativa facilidad, pero por su naturaleza los datos quedan opacados detrás de una estructura complicada que no es fácil hacer interactuar con otros paquetes; en particular, no es posible graficar utilizando `ggplot2`. 

La finalidad de `metR` es proveer facilidades en la lectura, manejo y visualización de datos meteorológicos en R utilizando estructuras comunes soportadas por la mayoría de los paquetes, de manera de poder beneficiarse de los aportes de la comunidad. Hace fuerte uso de `data.table` por su eficiencia en memoria y velocidad dada la gran cantidad de datos que suelen usarse en meteorología, y en `ggplot2` por su flexibilidad y facilidad en la creación de gráficos. 

# Ejemplo 

Como ejemplo, se usan los datos de altura geopotencial media mensual en el nivel de 700hPa entre 1990 y 2000, que vienen incluidos en `metR`. 

```{r, include = FALSE}
library(metR)
library(data.table)
library(ggplot2)
library(dplyr)
library(purrr)
data(geopotential)
geopotential <- copy(geopotential)

# Opciones estéticas de ggplot2 que sirven al graficar campos escalares. 
theme_field <- function(w = 4) {
   theme(legend.position = "bottom", legend.box = "vertical",
         legend.key.width = unit(w, "lines"),
         panel.grid = element_line(color = "gray20", size = 0.2, linetype = 3),
         panel.ontop = TRUE
   )
}

# Mapa.
map <- map_data("legacy_world2")
geom_map <- geom_path(data = map, aes(long, lat, group = group), color = "black", size = 0.2)   
```

Se calculan las anomalías temporales para cada puntos de grilla y calcular el campo asociado a la primera componente principal para cada mes. Finalmente, se calcula el viento geostrófico correspondiente a ese campo. Todo este proceso toma unas pocas líneas de código y se integra sin esfuerzo en el *workflow* de `data.table`. 

```{r}
geopotential[, gh.t := Anomaly(gh), by = .(lon, lat, month(date))]
geopotential[, gh.t.w := gh.t*sqrt(cos(lat*pi/180))]
eof <- geopotential[, EOF(gh.t.w ~ date | lon + lat, n = 1)$right, by = .(month(date))]
eof[, c("u", "v") := GeostrophicWind(gh.t.w, lon, lat), by = .(month)]
```

Luego, se grafica el campo de geopotencial con contornos llenos de manera que haya una relación uno a uno entre los niveles graficados y los señalados en la escala de colores. El campo de movimiento, por su parte, se grafica con líneas de corriente. 

```{r}
binwidth <- 0.01
ggplot(eof[month %in% 1:2], aes(lon, lat)) +
   geom_contour_fill(aes(z = gh.t.w), circular = "x", breaks = AnchorBreaks(0, binwidth, 0)) +
   geom_streamline(aes(dx = dlon(u, lat), dy = dlat(v)), L = 30, skip = 2) +
   geom_map +
   scale_fill_divergent(breaks = AnchorBreaks(0, binwidth, 0), guide = "colorstrip", name = "") +
   scale_y_latitude(ticks = 15) +
   scale_x_longitude() +
   coord_quickmap(xlim = c(0, 360), ylim = c(-90, -20)) +
   facet_wrap(~ month, ncol = 1, 
              labeller = labeller(month = setNames(month.abb, as.character(1:12)))) +
   theme_minimal() + theme_field()
```


# Limitaciones

El uso de `data.table`s para el manejo de datos implica una importante limitación para `metR`. Muchas aplicaciones meteorológicas hacen uso de cantidades de datos que resultan imposibles cargar en memoria RAM en la mayoría de las computadoras personales. `metR` tampoco puede manejar campos que no se encuentren en en grillas regulares o en grillas proyectadas. En ambos casos paquetes como `raster` y `rasterVis` son indispensables. 

`metR` está en estado experimental y de activo desarrollo, tanto en crecimiento de funcionalidad como en refinamiento de interfaces y corrección de errores. Como todo proyecto de código abierto, es deseable además que a medida que sea adoptado por la comunidad, surgan nuevos casos de uso que incentiven su evolución más allá de las necesidades personales de un sólo desarrollador. 